<!-- * description: 用户卡片 * version: 1.0 *
author:qingliang.zeng@hand-china.com * * -->
    <#include "../../include/header.html"/>
        <style>
            .photo {
                -moz-box-sizing: border-box;
                -webkit-box-sizing: border-box;
                box-sizing: border-box;
                width: 63px;
                height: 63px;
                border-radius: 22px;
                -moz-border-radius: 22px;
                -webkit-border-radius: 22px;
                border: 2px solid #38a9ac;
                background-size: 100% 100% !important;
                background-position: center center;
            }
            .icon-eye-open,.icon-eye-close{
                position: absolute;
                right: 16px;
                top: 3px;
            }
        </style>
<body style="padding: 10px;">
<script src="http://cdn.bootcss.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
<script src="${base.contextPath}/common/code?gender=HR.EMPLOYEE_GENDER" type="text/javascript"></script>
<script src="${base.contextPath}/common/code?customerCardType=CUSTOMER.CARD_TYPE" type="text/javascript"></script>
<script src="${base.contextPath}/common/code?payBankCode=PAY.BANK_CODE" type="text/javascript"></script>
<script src="${base.contextPath}/common/code?payCardType=PAY.CARD_TYPE" type="text/javascript"></script>
<script src="${base.contextPath}/common/code?identityTypeData=CSP.AUTH_TYPE" type="text/javascript"></script>
<div class="col-sm-12" style="margin-top: 10px;">
    <div id="tabstrip">
        <ul>
            <li id="baseInfoTab">基本信息</li>
            <li id="communityInfoTab">关注项目信息</li>
            <li id="appCardInfoTab">银行卡信息</li>
            <li id="authInfoTab">绑定账号信息</li>
        </ul>
        <div id="baseInfoTab-content">
            <div class="panel" id="baseInfo" style="padding: 0px;border:none;box-shadow: none;">
                <form class="form-horizontal" id="myForm" enctype="application/json;charset=UTF-8">
                    <div class="panel-body">
                        <div class="row" style="margin-bottom: 10px;" align="center">
                            <div class="col-sm-12" >
                                <div class="form-group" >
                                    <div id="photoDiv" class="photo" class="col-sm-12" style="background: url('${base.contextPath}/resources/images/user_default.jpg')"></div>
                                </div>
                            </div>
                        </div>
                        <br>
                        <div class="row" style="margin-bottom: 10px;">
                            <div class="col-sm-4">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label">手机号</label>
                                    <div class="col-sm-8">
                                        <input id="mobile" type="text" disabled="disabled"  style="width: 100%" data-bind="value:model.mobile" class="k-textbox k-state-disabled">
                                        <img id="mobileOpen" class="icon-eye-open" src="${base.contextPath}/resources/images/eye.png" />
                                        <img id="mobileClose" class="icon-eye-close" style="display: none" src="${base.contextPath}/resources/images/eye_close.png" />
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-4">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label">姓名</label>
                                    <div class="col-sm-8">
                                        <input type="text"  disabled="disabled" style="width: 100%" data-bind="value:model.userName" class="k-textbox k-state-disabled">
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-4">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label">邮箱</label>
                                    <div class="col-sm-8">
                                        <input type="text"  disabled="disabled" style="width: 100%" data-bind="value:model.email" class="k-textbox k-state-disabled">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row ">
                            <div class="col-sm-4">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label">昵称</label>
                                    <div class="col-sm-8">
                                        <input type="text" disabled="disabled"  disabled="disabled" style="width: 100%" data-bind="value:model.nickName" class="k-textbox k-state-disabled">
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-4">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label">性别</label>
                                    <div class="col-sm-8">
                                        <input style="width: 100%"  id="sex" disabled="disabled"  data-bind="value:model.sex" class="k-textbox k-state-disabled">
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-4">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label">积分余额</label>
                                    <div class="col-sm-8">
                                        <input style="width: 100%" disabled="disabled"  data-bind="value:model.integralBalance" class="k-textbox k-state-disabled">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row ">
                            <div class="col-sm-4">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label">注册时间</label>
                                    <div class="col-sm-8">
                                        <input style="width: 100%" disabled="disabled"  data-role="datetimepicker"   data-bind="value:model.retTime" class="k-datetimepicker k-state-disabled">
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-4">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label">注册邀请码</label>
                                    <div class="col-sm-8">
                                        <input style="width: 100%" disabled="disabled"  data-bind="value:model.registrationInvitationCode" class="k-textbox k-state-disabled">
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-4">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label">最后登录时间</label>
                                    <div class="col-sm-8">
                                        <input style="width: 100%" disabled="disabled"  data-role="datetimepicker" data-bind="value:model.lastTime" class="k-datetimepicker k-state-disabled" >
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row ">
                            <div class="col-sm-4">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label">归属省</label>
                                    <div class="col-sm-8">
                                        <input style="width: 100%" disabled="disabled"   data-bind="value:model.mobileProvince" class="k-textbox k-state-disabled">
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-4">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label">归属市</label>
                                    <div class="col-sm-8">
                                        <input style="width: 100%" disabled="disabled"  data-bind="value:model.mobileCity" class="k-textbox k-state-disabled">
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-4">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label">运营商</label>
                                    <div class="col-sm-8">
                                        <input style="width: 100%" disabled="disabled" data-bind="value:model.mobileSupplier" class="k-textbox k-state-disabled">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div style="clear: both;">
                <div id="baseInfoTabGrid"></div>
            </div>
        </div>
        <div id="communityInfoTab-content">
            <div class="panel" id="communityInfo" style="padding: 0px;border:none;box-shadow: none;">
                <form class="form-horizontal" id="myForm2" enctype="application/json;charset=UTF-8">
                    <div class="panel-body">
                        <div class="row" style="margin-bottom: 10px;">
                            <div class="col-sm-4">
                                <div class="form-group">
                                    <label class="col-sm-4 control-label">项目名称</label>
                                    <div class="col-sm-8">
                                        <input type="text" style="width: 100%" data-bind="value:communityModel.communityName" class="k-textbox">
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-4">
                                <span class="btn btn-primary" data-bind="click:queryResource" type="submit"><i class="fa fa-search" style="margin-right:3px;"></i><@spring.message "hap.query"/></span>
                                <span class="btn btn-default" type="button" data-bind="click:resetForm"><i class="fa fa-undo" style="margin-right:3px;"></i><@spring.message "hap.reset"/></span>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div style="clear: both;">
                <div id="communityInfoTabGrid"></div>
            </div>
        </div>
        <div id="appCardTab-content">
            <div class="panel" id="appCardInfo" style="padding: 0px;border:none;box-shadow: none;">
                <form class="form-horizontal" id="myForm3" enctype="application/json;charset=UTF-8">
                    <div class="panel-body">
                        <div style="clear: both;">
                            <div id="appCardInfoTabGrid"></div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div id="authInfoTab-content">
            <div class="panel" id="authInfo" style="padding: 0px;border:none;box-shadow: none;">
                <form class="form-horizontal" id="myForm4" enctype="application/json;charset=UTF-8">
                    <div class="panel-body">
                        <div style="clear: both;">
                            <div id="authInfoTabGrid"></div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
var tabToActivate = $("#baseInfoTab");
var tabstrip =  $("#tabstrip").kendoTabStrip({
        animation: {
            close: {
                duration: 200,
                effects: "fadeOut"
            },
            open: {
                duration: 200,
                effects: "fadeIn"
            }
        },
        show:function(e){
            if(e.item.id == "baseInfoTab"){

            }else if(e.item.id=="communityInfoTab"){
                Hap.autoResizeGrid("#communityInfoTabGrid");
                var grid = $("#communityInfoTabGrid").data("kendoGrid");
                var firstCell = grid.tbody.find("tr:first");
                firstCell.css({
                    background:'#64cde6',
                });
            }else if(e.item.id == "appCardInfoTab"){
                Hap.autoResizeGrid("#appCardInfoTabGrid");
                var grid = $("#appCardInfoTabGrid").data("kendoGrid");
                var firstCell = grid.tbody.find("tr:first");
                firstCell.css({
                    background:'#64cde6',
                });
            }else if(e.item.id == "authInfoTab"){
                Hap.autoResizeGrid("#authInfoTabGrid");
                var grid = $("#authInfoTabGrid").data("kendoGrid");
                var firstCell = grid.tbody.find("tr:first");
                firstCell.css({
                    background:'#64cde6',
                });
            }
        }

    }
).data("kendoTabStrip");
tabstrip.activateTab(tabToActivate);

var baseInfoTabviewModel = kendo.observable({
    model: {}
});
var communityInfoTabviewModel = kendo.observable({
    communityModel: {},
    queryResource: function (e) {
        $('#communityInfoTabGrid').data('kendoGrid').dataSource.page(1);
    },
    resetForm:function(e) {
        var formData = communityInfoTabviewModel.communityModel.toJSON();
        for (var k in formData) {
            communityInfoTabviewModel.communityModel.set(k, null);
        }
    }
});
var appCardModel = kendo.observable({
    model: {},
    customerCardType:customerCardType,
    payBankCode:payBankCode,
    payCardType:payCardType,
});

kendo.bind($('#baseInfo'), baseInfoTabviewModel);
kendo.bind($('#communityInfo'), communityInfoTabviewModel);
kendo.bind($('#appCardInfo'), appCardModel);

$("#sex").kendoDropDownList({
    valuePrimitive:true,
    dataTextField: "meaning",
    dataValueField: "value",
    dataSource: gender
});

//初始化form表单
var mobileHidden = "";
$.ajax({
    url: '${base.contextPath}/ljh/app/user/get',
    type : "GET",
    dataType : "json",
    contentType : "application/json",
    data : {id:'${RequestParameters.id!0}'},
    success: function (args) {
        var profile = args.dto||{};
        for(var i in profile){
            baseInfoTabviewModel.set("model."+i,profile[i]);
        }

        if(null!=baseInfoTabviewModel.get("model.userIcon")&&""!=baseInfoTabviewModel.get("model.userIcon")){
            $("#photoDiv").css("background-image","url("+profile["fastdfsImageServer"]+baseInfoTabviewModel.get("model.userIcon")+")");
        }
        var mobile = $("#mobile").val();
        if(mobile != null && mobile != ""){
            mobile = mobile.substring(0,3)+"****"+mobile.substring(7);
        }
        $("#mobile").val(mobile);
        mobileHidden = mobile;
    }
});


var BaseUrl = _basePath;
dataSource = new kendo.data.DataSource({
    transport: {
        read: {
            url: BaseUrl+"/ljh/app/user/getCommunityList?id="+'${RequestParameters.id!0}',
            type: "POST",
            dataType: "json"
        },
        parameterMap: function (options, type) {
            if (type !== "read" && options.models) {
                var datas = Hap.prepareSubmitParameter(options, type)
                return kendo.stringify(datas);
            } else if (type === "read") {
                console.log(options);
                return Hap.prepareQueryParameter(communityInfoTabviewModel.communityModel.toJSON(), options)
            }
        }
    },
    batch: true,
    serverPaging: true,
    pageSize: 10,
    schema: {
        data: 'rows',
        total: 'total',
        model: {
            id: "id",
            fields: {}
        }
    }
});
$("#communityInfoTabGrid").kendoGrid({
    dataSource: dataSource,
    height: '100%',
    resizable: true,
    scrollable: true,
    navigatable: false,
    //selectable: 'multiple, rowbox',
    pageable: {
        pageSizes: [5, 10, 20, 50],
        refresh: true,
        buttonCount: 5
    },
    columns: [
        {
            field: "companyName",
            title: '物业公司名称',
            headerAttributes: {
                "class": "table-header-cell",
                style: "text-align: center"
            },
            width: 100
        },
        {
            field: "communityName",
            title: '项目名称',
            headerAttributes: {
                "class": "table-header-cell",
                style: "text-align: center"
            },
            width: 100
        },
        {
            field: "lastUpdateDate",
            title: '关注时间',
            headerAttributes: {
                "class": "table-header-cell",
                style: "text-align: center"
            },
            attributes: {style: "text-align:right"},
            width: 60
        }
    ],
    editable: false
});

dataSource1 = new kendo.data.DataSource({
    transport: {
        read: {
            url: BaseUrl+"/csp/app/user/card/list?appUserId="+'${RequestParameters.id!0}',
            type: "POST",
            dataType: "json"
        },
        parameterMap: function (options, type) {
            if (type !== "read" && options.models) {
                var datas = Hap.prepareSubmitParameter(options, type)
                return kendo.stringify(datas);
            } else if (type === "read") {
                return Hap.prepareQueryParameter(communityInfoTabviewModel.communityModel.toJSON(), options)
            }
        }
    },
    batch: true,
    serverPaging: true,
    pageSize: 10,
    schema: {
        data: 'rows',
        total: 'total',
        model: {
            id: "id",
            fields: {}
        }
    }
});
$("#appCardInfoTabGrid").kendoGrid({
    dataSource: dataSource1,
    height: '100%',
    resizable: true,
    scrollable: true,
    navigatable: false,
    //selectable: 'multiple, rowbox',
    pageable: {
        pageSizes: [5, 10, 20, 50],
        refresh: true,
        buttonCount: 5
    },
    columns: [
        {
            field: "idType",
            title: '证件类型',
            headerAttributes: {
                "class": "table-header-cell",
                style: "text-align: center"
            },
            width: 100,
            template: function(dataItem){
                var v = dataItem.idType;
                $.each(customerCardType,function(i,n){b
                    if((n.value||'').toLowerCase() == (v||'').toLowerCase()){
                        v = n.meaning;
                        return v;
                    }
                })
                return v;
            }
        },
        {
            field: "idNo",
            title: '证件号',
            headerAttributes: {
                "class": "table-header-cell",
                style: "text-align: center"
            },
            width: 140
        },
        {
            field: "name",
            title: '姓名',
            headerAttributes: {
                "class": "table-header-cell",
                style: "text-align: center"
            },
            width: 100,
        },
        {
            field: "bankCode",
            title: '银行名称',
            headerAttributes: {
                "class": "table-header-cell",
                style: "text-align: center"
            },
            width: 100,
            template: function(dataItem){
                var v = dataItem.bankCode;
                $.each(payBankCode,function(i,n){
                    if((n.value||'').toLowerCase() == (v||'').toLowerCase()){
                        v = n.meaning;
                        return v;
                    }
                })
                return v;
            }
        },
        {
            field: "cardType",
            title: '卡类型',
            headerAttributes: {
                "class": "table-header-cell",
                style: "text-align: center"
            },
            width: 100,
            template: function(dataItem){
                var v = dataItem.cardType;
                $.each(payCardType,function(i,n){
                    if((n.value||'').toLowerCase() == (v||'').toLowerCase()){
                        v = n.meaning;
                        return v;
                    }
                })
                return v;
            }
        },
        {
            field: "cardNo",
            title: '卡号',
            headerAttributes: {
                "class": "table-header-cell",
                style: "text-align: center"
            },
            width: 140
        },
        {
            field: "status",
            title: '状态',
            headerAttributes: {
                "class": "table-header-cell",
                style: "text-align: center"
            },//Y:已绑定 N:已解绑
            width: 80,
            template: function(dataItem){
                var v = dataItem.status;
                if(v != null && v != ""){
                    if(v == "Y"){
                        v = "已绑定";
                    }else if(v == "N"){
                        v = "已解绑";
                    }else{
                        v = "";
                    }
                }
                return v;
            }
        },
    ],
    editable: false
});

dataSourceAuth = new kendo.data.DataSource({
    transport: {
        read: {
            url: BaseUrl+"/csp/ljh/app/user/auth/query?appUserId="+'${RequestParameters.id!0}',
            type: "POST",
            dataType: "json"
        },
        parameterMap: function (options, type) {
            if (type !== "read" && options.models) {
                var datas = Hap.prepareSubmitParameter(options, type)
                return kendo.stringify(datas);
            } else if (type === "read") {
                return Hap.prepareQueryParameter(communityInfoTabviewModel.communityModel.toJSON(), options)
            }
        }
    },
    batch: true,
    serverPaging: true,
    pageSize: 10,
    schema: {
        data: 'rows',
        total: 'total',
        model: {
            id: "id",
            fields: {}
        }
    }
});
$("#authInfoTabGrid").kendoGrid({
    dataSource: dataSourceAuth,
    height: '100%',
    resizable: true,
    scrollable: true,
    navigatable: false,
    //selectable: 'multiple, rowbox',
    pageable: {
        pageSizes: [5, 10, 20, 50],
        refresh: true,
        buttonCount: 5
    },
    columns: [
        {
            title: '绑定账号',
            headerAttributes: {
                "class": "table-header-cell",
                style: "text-align: center"
            },
            width: 100,
            template: function(dataItem){
                var v = dataItem.identityType;
                $.each(identityTypeData,function(i,n){
                    if((identityTypeData.value||'').toLowerCase() == (v||'').toLowerCase()){
                        v = n.meaning;
                        return v;
                    }
                })
                return v;
            }
        },
        {
            field: "uuid",
            title: 'uuid',
            headerAttributes: {
                "class": "table-header-cell",
                style: "text-align: center"
            },
            width: 100,
        },
        {
            field: "nickName",
            title: '昵称',
            headerAttributes: {
                "class": "table-header-cell",
                style: "text-align: center"
            },
            width: 100,
        },
        {
            field: "avatar",
            title: '头像',
            headerAttributes: {
                "class": "table-header-cell",
                style: "text-align: center"
            },
            width: 100,
            template: function(dataItem){
                if(null!=dataItem.avatar&&""!=dataItem.avatar){
                    var src = dataItem.fastdfsImageServer+dataItem.avatar;
                    return "<img src=\""+src+"\" style='max-width:30 px;max-height:30px;'>";
                }else{
                    return "";
                }

            }
        },
        {
            title: '操作',
            width: 60,
            headerAttributes: {
                "class": "table-header-cell",
                style: "text-align: center"
            },
            attributes: {style: "text-align:center"},
            template : function (dataItem) {
                if (!!dataItem.authId) {
                    return "<a class='caozuo_btn' href='javascript:void(0)' onclick=unbind('"+dataItem.authId+"')>解绑</a>"
                }else return ''
            }

        },
    ],
    editable: false
});

function unbind(authId) {
    jsonArray = []
    jsonArray.push({'authId': authId})
    $.ajax({
        type: 'post',
        url: _basePath + '/csp/ljh/app/user/auth/remove',
        data:JSON.stringify(jsonArray),
        //headers: {
//        Aaccept:"application/json"
//        },
        beforeSend: function(request){
          request.setRequestHeader("Content-Type","application/json")
        },
        dataType: 'application/json',
        success: function (data) {
            if(data){
                kendo.ui.showInfoDialog({
                    title: $l('hap.tip.info'),
                    message: '解绑成功!'
                }).done(function () {
                    dataSourceAuth.read()
                });
            }
        }
    })
}
$(document).ready(function(){

});

$("#mobileOpen").click(function(){
    $("#mobile").val(baseInfoTabviewModel.model.mobile);
    $("#mobileOpen").css({"display":"none"});
    $("#mobileClose").css({"display":""});
});
$("#mobileClose").click(function(){
    $("#mobile").val(mobileHidden);
    $("#mobileOpen").css("display","");
    $("#mobileClose").css("display","none");
});
</script>

</body>
</html>
